---
- hosts: all
  become: true
  vars:
    container_image: flask_image
    container_name: flask_app

  tasks:
    - name: Creates directory
      file:
        path: /home/webapps/devops
        state: directory

    - name: Clone from github
      git:
        repo: 'https://bitbucket.org/azneita/devops-challenge.git'
        dest: /home/webapps/devops

    - name: Install aptitude using apt
      apt: name=aptitude state=latest update_cache=yes force_apt_get=yes

    - name: Install required system packages
      apt: name={{ item }} state=latest update_cache=yes
      loop: [ 'apt-transport-https', 'ca-certificates', 'curl', 'software-properties-common', 'python3-pip', 'virtualenv', 'python3-setuptools', 'python-docker']

    - name: Add Docker GPG apt Key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker Repository
      apt_repository:
        repo: deb https://download.docker.com/linux/ubuntu xenial stable
        state: present

    - name: Update apt and install docker.io
      apt: update_cache=yes name=docker.io state=latest

    #- name: Install Docker Module for Python
     # pip:
      #  name: docker
       # executable: pip3

    - name: Pull default Docker image
      docker_image:
        name: "{{ container_image }}"
        build:
          path: ./
          args:
            log_volume: /var/log/flask_app
        source: build

    - name: Create default containers
      command: docker run --restart always --log-opt max-size=50m --log-out max-file=5 -d --name "{{ container_name }}" -p 80:5000 "{{ container_image }}"
